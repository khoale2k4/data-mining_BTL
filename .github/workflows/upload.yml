name: Upload PDF to Google Drive

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    environment: Drive API

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Google API client
        run: pip install google-auth google-auth-httplib2 google-auth-oauthlib google-api-python-client

      - name: Upload PDF to Google Drive (overwrite)
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          echo "$GDRIVE_CREDENTIALS" | base64 --decode > credentials.json
          python <<'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          FILE_ID = "10VWcl16LboKoA9Ns00ralTIU6zSOyOBK"  # file cần ghi đè
          LOCAL_PATH = "report/DataMining-ReportBTL.pdf"

          SCOPES = ["https://www.googleapis.com/auth/drive"]
          creds = service_account.Credentials.from_service_account_file("credentials.json", scopes=SCOPES)
          service = build("drive", "v3", credentials=creds)

          media = MediaFileUpload(LOCAL_PATH, mimetype="application/pdf", resumable=True)
          updated_file = service.files().update(
              fileId=FILE_ID,
              media_body=media
          ).execute()
          print(f"File overwritten successfully: {updated_file.get('id')}")
          EOF
